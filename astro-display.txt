#!/usr/local/bin/bash

function clk {
        echo -en '\xfe\x51' > /dev/cuau2
        echo -en '\xfe\x46' > /dev/cuau2
        tput cuu 2
        echo -en `date +'%a %B %e %Y'` > /dev/cuau2
        echo -en '\xfe\x45\x40' > /dev/cuau2
        echo -en '\xfe\x4a' > /dev/cuau2
        echo -en '\xfe\x4a' > /dev/cuau2
        echo -en '\xfe\x4a' > /dev/cuau2
        echo -en '\xfe\x4a' > /dev/cuau2
        echo -en '\xfe\x4a' > /dev/cuau2
        echo -en `date +'%H:%M:%S'` > /dev/cuau2
        sleep 1
}

function aclk {
        echo -en '\xfe\x51' > /dev/cuau2
	echo -en '\xfe\x46' > /dev/cuau2
	echo -en 'Sunset : ' > /dev/cuau2
	sunwait -p [Replace with Long/Latt values] | tail -n 4 | head -n 1 | cut -w -f 7 |tr '\n' ' ' | sed 's/../&:/1' > /dev/cuau2
        echo -en '\xfe\x45\x40' > /dev/cuau2
	echo -en 'Sunrise: ' > /dev/cuau2 > /dev/cuau2
	sunwait -p [Replace with Long/Latt values] | tail -n 4 | head -n 1 | cut -w -f 4 |tr '\n' ' ' |  sed 's/../&:/1' > /dev/cuau2
}

function ntpsvr {
        echo -en '\xfe\x51' > /dev/cuau2
	echo -en '\xfe\x46' > /dev/cuau2
	echo -en 'Remote 1: ' > /dev/cuau2
	echo -en '\xfe\x45\x40' > /dev/cuau2
	echo -en 'Remote 2: ' > /dev/cuau2
	sleep 2
        echo -en '\xfe\x51' > /dev/cuau2
	echo -en '\xfe\x46' > /dev/cuau2
	ntpq -wp | tail -n 3 | head -n 1 | cut -f 1 -d ' ' | tr '\n' ' ' > /dev/cuau2
        echo -en '\xfe\x45\x40' > /dev/cuau2
	ntpq -wp | tail -n 1 | head -n 1 | cut -f 1 -d ' ' | tr '\n' ' ' > /dev/cuau2
}

function ntpdoj {
        echo -en '\xfe\x51' > /dev/cuau2
	echo -en '\xfe\x46' > /dev/cuau2
	echo -en 'Display1  ' > /dev/cuau2
        echo -en 'Offset1  ' > /dev/cuau2
        echo -en 'Jitter1' > /dev/cuau2
	echo -en '\xfe\x45\40' > /dev/cuau2
        echo -en 'Delay2  ' > /dev/cuau2
        echo -en 'Offset2  ' > /dev/cuau2
        echo -en 'Jitter2  ' > /dev/cuau2
	while true
	do
		echo -en '\xfe\x51' > /dev/cuau2
		echo -en '\xfe\x46' > /dev/cuau2
		ntpq -p | tail -n 2 | head -n 1 | cut -w -f 8 | tr '\n' ' ' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
        	ntpq -p | tail -n 2 | head -n 1 | cut -w -f 9 | tr '\n' ' ' > /dev/cuau2
		echo -en '\xfe\x4a' > /dev/cuau2
        	ntpq -p | tail -n 2 | head -n 1 | cut -w -f 10 | tr '\n' ' ' > /dev/cuau2
                echo -en '\xfe\x45\x40' > /dev/cuau2
                ntpq -p | tail -n 1 | cut -w -f 8 | tr '\n' ' ' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                ntpq -p | tail -n 2 | cut -w -f 9 | tr '\n' ' ' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                ntpq -p | tail -n 2 | cut -w -f 10 | tr '\n' ' ' > /dev/cuau2
		sleep 1
		if [[ `gpioctl 26` -eq 1 ]];
                then
                        echo -en '\xfe\x51' > /dev/cuau2
                        echo -en '\xfe\x46' > /dev/cuau2
                        echo -en 'Break' > /dev/cuau2
                        sleep 2
                        echo -en '\xfe\x45\x40' > /dev/cuau2
                        echo -en 'Push Button!' > /dev/cuau2
                        return 1
                fi
	done
}

function ntp {
        echo -en '\xfe\x51' > /dev/cuau2
        echo -en '\xfe\x46' > /dev/cuau2
        echo -en 'mintc=' > /dev/cuau2
        echo -en '\xfe\x45\x09' > /dev/cuau2
        echo -en 'freq=' > /dev/cuau2
        echo -en '\xfe\x45\x49' > /dev/cuau2
        echo -en '\xfe\x4a' > /dev/cuau2
        echo -en '|' > /dev/cuau2
        while true
        do
                echo -en '\xfe\x45\x06' > /dev/cuau2
                ntpq -c readlist | grep offset | cut -f 1 -d ',' | cut -f 2 -d '=' | tr '\n' ' ' > /dev/cuau2
                echo -en '\xfe\x45\x09' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                ntpq -c readlist | grep offset | cut -f 3 -d ',' | cut -f 2 -d '=' | sed -e 's/^[[:space:]]*//' |tr '\n' ' ' > /dev/cuau2
                echo -en '\xfe\x45\x40' > /dev/cuau2
                ntpq -c readlist | grep offset | cut -f 2 -d ',' | cut -f 2 -d '=' | sed -e 's/^[[:space:]]*//' |tr '\n' ' ' > /dev/cuau2
                echo -en '\xfe\x45\x49' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                echo -en '\xfe\x4a' > /dev/cuau2
                ntpq -c readlist | grep offset | cut -f 4 -d ',' | cut -f 2 -d '=' | sed -e 's/^[[:space:]]*//' |tr '\n' ' ' > /dev/cuau2
		sleep 1
                if [[ `gpioctl 26` -eq 1 ]];
		then
                        echo -en '\xfe\x51' > /dev/cuau2
                        echo -en '\xfe\x46' > /dev/cuau2
                        echo -en 'Break' > /dev/cuau2
                        sleep 2
                        echo -en '\xfe\x45\x40' > /dev/cuau2
                        echo -en 'Push Button!' > /dev/cuau2
                        return 1
                fi
        done
}
count=0
echo -en '\xfe\x51' > /dev/cuau2
echo -en '\xfe\x46' > /dev/cuau2
echo -en 'Time/Date - Screen:'$count > /dev/cuau2
sleep 1
while true;
do
    if [[ `gpioctl 26` -eq 0 ]];
    then
	if [[ $count -eq 0 ]]; then
		clk
	fi
    elif
	((count=$count+1)); then
	case $count in
		1)
			echo $count
			echo "press1"
        		echo -en '\xfe\x51' > /dev/cuau2
        		echo -en '\xfe\x46' > /dev/cuau2
        		echo -en 'Astro Clock -' > /dev/cuau2
			echo -en '\xfe\x45\x40' > /dev/cuau2
			echo -en 'Screen:'$count > /dev/cuau2
        		sleep 1
			aclk
			sleep 1
		;;
		2)
                        echo $count
                        echo "press2"
                        echo -en '\xfe\x51' > /dev/cuau2
                        echo -en '\xfe\x46' > /dev/cuau2
                        echo -en 'NTP Servers -' > /dev/cuau2
                        echo -en '\xfe\x45\x40' > /dev/cuau2
			echo -en 'Screen:'$count > /dev/cuau2
                        sleep 1
                        ntpsvr
                        sleep 1

		;;
		3)
                        echo $count
                        echo "press3"
                        echo -en '\xfe\x51' > /dev/cuau2
                        echo -en '\xfe\x46' > /dev/cuau2
                        echo -en 'NTP - Screen:'$count > /dev/cuau2
			echo -en '\xfe\x45\x40' > /dev/cuau2
			echo -en 'Delay/Offset/Jitter' > /dev/cuau2
                        sleep 1
                        ntpdoj
                        sleep 1
		;;
		4)
			echo $count
			echo "press4"
		        echo -en '\xfe\x51' > /dev/cuau2
        		echo -en '\xfe\x46' > /dev/cuau2
        		echo -en 'NTP Info - Screen:'$count > /dev/cuau2
        		sleep 1
               		ntp
			sleep 1
		;;
		5)
			echo $count
			echo "press5"
			count=0
			sleep 1
        		echo -en '\xfe\x51' > /dev/cuau2
        		echo -en '\xfe\x46' > /dev/cuau2
			echo -en 'Time/Date - Screen:'$count > /dev/cuau2
        		sleep 1
		;;
	esac
    fi
done
